<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/common.css" />
		<link rel="stylesheet" href="../../css/iconfont.css" />
		<style>
			#listInfo .mui-table-view-cell {
				background: #fff;
				padding: 0;
			}
			
			.listItem {
				display: flex;
				display: -webkit-flex;
				box-sizing: border-box;
				padding: 12px;
				width: 100%;
				background: #fff;
			}
			
			.sysItem {
				display: flex;
				display: -webkit-flex;
				box-sizing: border-box;
				padding: 12px;
				width: 100%;
				background: #fff;
			}
			
			.listItem .listPic {
				width: 70px;
				height: 50px;
				max-width: 50px;
				position: relative;
				margin-right: 14px;
			}
			
			.sysItem .listPic {
				width: 70px;
				height: 50px;
				max-width: 50px;
				position: relative;
				margin-right: 14px;
			}
			
			.listItem .listPic img {
				width: 100%;
				height: 100%;
				border-radius: 5px;
			}
			
			.sysItem .listPic img {
				width: 100%;
				height: 100%;
				border-radius: 5px;
			}
			
			.listItem .newsTip {
				position: absolute;
				background: red;
				color: #fff;
				height: 20px;
				width: 20px;
				top: -10px;
				right: -10px;
				font-size: 12px;
				border-radius: 50%;
				line-height: 20px;
				text-align: center;
				display: none;
			}
			
			.sysItem .newsTip {
				position: absolute;
				background: red;
				color: #fff;
				height: 20px;
				width: 20px;
				top: -10px;
				right: -10px;
				font-size: 12px;
				border-radius: 50%;
				line-height: 20px;
				text-align: center;
				display: none;
			}
			
			.listtxt {
				width: 80%;
			}
			
			.time {
				color: #6D6D72;
				font-size: 12px;
				float: right;
				font-weight: 400;
				line-height: 18px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" style="background: #212121;" id="header">

			<h1 class="mui-title" style="color:#fff">最近聊天</h1>
		</header>

		<div class=" mui-scroll-wrapper" id="content">
			<div id="listInfoBox" class="mui-scroll">

				<!--<p class="t_c lh36">系统升级中。。。</p>-->

				<div class="mui-slider-handle sysItem">
					<div class="mui-media-object mui-pull-left listPic ">
						<img src="../../images/sys.png">
						<span class="newsTip" id="sysRed">
								          0
								    </span>
					</div>
					<div class="mui-media-body listtxt">
						<h4>
							<span>系统消息</span>
							<span class="time " id="sysTime">--:--:--</span>
						</h4>
						<p class='mui-ellipsis cor_g' id="sysTxt"></p>
					</div>
				</div>

				<ul class="mui-table-view" id="listInfo">
					<script id="friends" type="text/template">
						{{each list value i}}

						<li class="mui-table-view-cell mui-media ">
							<div class="mui-slider-right mui-disabled">
								<a class="mui-btn mui-btn-red delect" style="transform: translate(-180px, 0px);" userid={{value.targetId}}>删除</a>
							</div>
							<div class="mui-slider-handle listItem" id={{ 'fdBox'+value.targetId}} style="transform: translate(0px, 0px);" userid={{value.targetId}} key={{i}}>
								<div class="mui-media-object mui-pull-left listPic ">
									<img src={{value.avatar}} id={{ 'fdAvatar'+value.targetId}}>
									<span class="newsTip" id={{ 'fdRed'+value.targetId}}>
								          0
								    </span>
								</div>
								<div class="mui-media-body listtxt">
									<h4 class="flex">
										<span id={{'fdName'+value.targetId}} class="ellipsis" style="width: 50%;display: block">{{value.nickName}}</span>
										<span id={{'fdTime'+value.targetId}} class="time f1 t_r"></span>
									</h4>
									<p class='mui-ellipsis' id={{ 'fdTxt'+value.targetId}}></p>
								</div>
							</div>
						</li>
						{{/each}}
					</script>

				</ul>
			</div>
		</div>
		<script src="https://cdn.ronghub.com/RongIMLib-2.3.2.min.js"></script>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/app.js"></script>
		<script type="text/javascript" src="../../js/arttemp.js"></script>
		<script src="../../js/db.js"></script>

		<script type="text/javascript">
			"use strict";

			mui.init({
				swipeBack: false,
				pullRefresh: {
					container: "#content", //下拉刷新容器标识，querySelector能定位的css选择器均可，比如：id、.class等
					up: {
						height: 50, //可选,默认50.触发下拉刷新拖动距离,
						auto: false, //可选,默认false.首次加载自动下拉刷新一次
						contentup: "上拉可以刷新", //可选，在下拉可刷新状态时，下拉刷新控件上显示的标题内容
						contentnomore: '没有更多数据了', //可选，在释放可刷新状态时，下拉刷新控件上显示的标题内容
						contentrefresh: "正在刷新...", //可选，正在刷新状态时，下拉刷新控件上显示的标题内容
						callback: function callback() {
							getList(function() {
								mui.later(function() {
									mui('#content').pullRefresh().endPullupToRefresh();
								}, 1500);
							});
						} //必选，刷新函数，根据具体业务来编写，比如通过ajax从服务器获取新数据；
					}
				}
			});

			//				当前页条数		
			var pageSize = 10;
			//				当前页码	
			var pageIndex = 1;
			var friends;
			getList();

			var main_loaded_flag;
			var mainPage;
			mui.plusReady(function() {

				//				初始化聊天记录列表
				app.initHeader();
				mainPage = plus.webview.getWebviewById("chat");
				//			获取即时通讯的token
				//							console.log(token)
				//预加载页面,之前需要通过后台获取token

				InitIM();

				mainPage.addEventListener("loaded", function() {
					main_loaded_flag = true;
				});

				mui.back = function(event) {
					plus.webview.currentWebview().hide();
				};

				var toChat = function toChat() {
					var id = setInterval(function() {
						if(main_loaded_flag) {
							clearInterval(id);
							mainPage.show("pop-in", 300, function() {}, {});
						}
					}, 1000);
				};
				//				点击进入聊天详情页
				mui('#listInfoBox').on('tap', '.listItem', function() {
					var fdId = this.getAttribute('userid');

					var fdAvatar = document.getElementById('fdAvatar' + fdId).getAttribute('src');

					var fdname = document.getElementById('fdName' + fdId).innerText;
					mainPage.evalJS('initHis("' + fdId + '","' + fdname + '","' + fdAvatar + '")');
					toChat();

					document.getElementById('fdRed' + fdId).innerText = 0;
					document.getElementById('fdRed' + fdId).style.display = 'none';
				});
				//				//				点击删除
				mui('#listInfoBox').on('tap', '.delect', function() {
					var fdId = this.getAttribute('userid');
					//					删除操作	
					var li = this.parentNode.parentNode;
					mui.swipeoutClose(li);
					li.parentNode.removeChild(li);
					//					alert(fdId)
					DB.delectDataByIndex(fdId);
				});

				mui('#listInfoBox').on('tap', '.sysItem', function() {
					mui.openWindow({
						url: './sysMessage.html',
						id: 'sysMessage',
						styles: {
							top: '0px', //新页面顶部位置
							bottom: '0px', //新页面底部位置
							scrollIndicator: "none",
							plusrequire: 'ahead',
							titleNView: {
								autoBackButton: true, // 标题栏文字,当不设置此属性时，默认加载当前页面的标题，并自动更新页面的标题
								titleColor: "#fff", // 字体颜色,颜色值格式为"#RRGGBB",默认值为"#000000"
								titleSize: "14px", // 字体大小,默认17px
								backgroundColor: "#151515", // 控件背景颜色,颜色值格式为"#RRGGBB",默认值为"#F7F7F7"
								progress: { // 标题栏控件的进度条样式
									color: "#ccaa42", // 进度条颜色,默认值为"#00FF00"
									height: "2px" // 进度条高度,默认值为"2px"         
								},
								splitLine: { // 标题栏控件的底部分割线，类似borderBottom
									color: "#404040", // 分割线颜色,默认值为"#CCCCCC"  
									height: "1px" // 分割线高度,默认值为"2px"
								}
							}
						},
						createNew: true, //是否重复创建同样id的webview，默认为false:不重复创建，直接显示
						show: {
							autoShow: true, //页面loaded事件发生后自动显示，默认为true
							duration: 300 //页面动画持续时间，Android平台默认100毫秒，iOS平台默认200毫秒；
						},
						extras: {},
						waiting: {
							autoShow: true, //自动显示等待框，默认为true
							title: '正在加载...' //等待对话框上显示的提示内容
						}
					});
				});
			});

			//			刷新最近聊天的对象列表
			function getList(callback) {
				var time = setInterval(function() {
					if(!DB.db) {} else {
						DB.getCount(function(res) {

							friends = {
								list: res,
								time: function time(str) {
									return new Date(str).Format('MM-dd hh:mm:ss');
								}
							};
							var html = template('friends', friends);
							document.getElementById('listInfo').innerHTML = html;
							if(callback) callback();
						});
						mui('#content').pullRefresh().endPullupToRefresh();
						clearInterval(time);
					}
				}, 200);
			}
			//			接收到对方消息,列表页消息提示变化
			function receive(data) {
				var getor = data.senderUserId;
				var time;
				var text;
				var box = document.getElementById('fdBox' + getor);
				if(box) {
					//					已经存在的聊天对象
					time = document.getElementById('fdTime' + getor);
					text = document.getElementById('fdTxt' + getor);

					time.innerText = new Date().Format("yyyy-MM-dd hh:mm:ss");

					if(data.messageType == 'TextMessage') {
						text.innerText = data.content.content;
					} else if(data.messageType == 'LocationMessage') {
						text.innerText = '向您发送了位置';
					} else if(data.messageType == 'VoiceMessage') {
						text.innerText = '语音信息';
					} else {
						text.innerText = '图片';
					}
					var m = document.getElementById('fdRed' + getor);
					m.style.display = 'block';
					m.innerText = parseInt(m.innerText) + 1;
				} else {
					//					表示是新的聊天天对象
					friends.list.push({
						userId: getor,
						avatar: data.content.extra.avatar,
						msgList: [].push(data)
					});

					getList(function() {
						var m = document.getElementById('fdRed' + getor);
						if(!m) return;
						m.innerText = 1;
						time = document.getElementById('fdTime' + getor);
						text = document.getElementById('fdTxt' + getor);

						time.innerText = new Date().Format("yyyy-MM-dd hh:mm:ss");

						if(data.messageType == 'TextMessage') {
							text.innerText = data.content.content;
						} else if(data.messageType == 'LocationMessage') {
							text.innerText = '向您发送了位置';
						} else if(data.messageType == 'VoiceMessage') {
							text.innerText = '语音信息';
						} else {
							text.innerText = '图片';
						}
						m.style.display = 'block';
					});
				}
			}
			//自己发送消息
			function send(data) {

				var getor = data.targetId;
				var time;
				var text;
				var box = document.getElementById('fdBox' + getor);
				if(box) {
					//					已经存在的聊天对象
					time = document.getElementById('fdTime' + getor);
					text = document.getElementById('fdTxt' + getor);

					time.innerText = new Date().Format("yyyy-MM-dd hh:mm:ss");

					if(data.messageType == 'TextMessage') {
						text.innerText = data.content.content;
					} else if(data.messageType == 'LocationMessage') {
						text.innerText = '发送了位置信息';
					} else if(data.messageType == 'VoiceMessage') {
						text.innerText = '语音信息';
					} else {
						text.innerText = '图片';
					}
				} else {
					//					表示是新的聊天天对象
					friends.list.push({
						userId: getor,
						avatar: data.content.extra.avatar,
						msgList: [].push(data)
					});

					getList(function() {

						time = document.getElementById('fdTime' + getor);
						text = document.getElementById('fdTxt' + getor);

						time.innerText = new Date().Format("yyyy-MM-dd hh:mm:ss");

						if(data.messageType == 'TextMessage') {
							text.innerText = data.content.content;
						} else if(data.messageType == 'LocationMessage') {
							text.innerText = '发送了位置信息';
						} else if(data.messageType == 'VoiceMessage') {
							text.innerText = '语音信息';
						} else {
							text.innerText = '图片';
						}
					});
				}
			}
			//			新消息产生红点提示
			function redSet(msg) {
				var m = document.getElementById('sysRed');
				m.style.display = 'block';
				m.innerText = parseInt(m.innerText) + 1;

				var t = document.getElementById('sysTime');
				t.innerText = new Date().Format('MM-dd hh:mm:ss');

				var c = document.getElementById('sysTxt');
				c.innerText = msg;
			}

			function redClean(msg) {
				var m = document.getElementById('sysRed');
				m.style.display = 'none';
				m.innerText = 0;
			}

			function InitIM() {
				//				alert('InitIM')
				main_loaded_flag = false;
				if(!mainPage) {
					mainPage = mui.preload({
						"id": 'chat',
						"url": './chat.html',
						'styles': {}
					});
				} else {
					main_loaded_flag = true;
				}
			}
			Date.prototype.Format = function(fmt) {
				// author: meizz
				var o = {
					"M+": this.getMonth() + 1, // 月份
					"d+": this.getDate(), // 日
					"h+": this.getHours(), // 小时
					"m+": this.getMinutes(), // 分
					"s+": this.getSeconds(), // 秒
					"q+": Math.floor((this.getMonth() + 3) / 3), // 季度
					"S": this.getMilliseconds() // 毫秒
				};
				if(/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
				for(var k in o) {
					if(new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, RegExp.$1.length == 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length));
				}
				return fmt;
			};
		</script>
	</body>

</html>