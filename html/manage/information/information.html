<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>消息中心</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<script src="http://cdn.ronghub.com/RongIMLib-2.3.3.min.js"></script>
		<script src="../../../js/arttemp.js"></script>
		<script src="../../../js/emoji.js"></script>
		<script src="../../../js/mui.min.js"></script>
		<link href="../../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../../css/common.css" />
		<link rel="stylesheet" href="../../../css/iconfont.css" />
		<link rel="stylesheet" href="../../../css/im.css" />
		<link rel="stylesheet" href="../../../css/animate.css" />
		<link rel="stylesheet" type="text/css" href="../../../css/IMiconfont.css">
		<style type="text/css">
			.sysItem {
				background: #fff;
			}
			
			#noRest {
				display: none;
			}
			
			.timeTip {
				/*width: 120px;*/
				padding: 0 15px;
				line-height: 30px;
				background: #e3e3e3;
				/*border: 1px solid #d3d3d3;*/
				box-sizing: 0 0 2px #d3d3d3;
				border-radius: 4px;
				margin: 10px auto;
				color: #fff
			}
		</style>
	</head>

	<body>
		<!--聊天对象页面-->
		<div class="" id="block_list">
			<div id="listInfoBox" class="">
				<div class="mui-slider-handle sysItem">
					<div class="mui-media-object mui-pull-left listPic ">
						<img src="../../../images/sys.png">
						<span class="newsTip" id="sysRed">
								          0
						</span>
					</div>
					<div class="mui-media-body listtxt">
						<h4>
							<span>系统消息</span>
							<span class="time " id="sysTime">--:--:--</span>
						</h4>
						<p class='mui-ellipsis cor_g' id="sysTxt"></p>
					</div>
				</div>

				<ul class="mui-table-view " id="listInfo" style="min-height: 102%;">

				</ul>
			</div>
		</div>
		<!--聊天内容页面-->
		<div id="block_chat" class="animated slideInRight">
			<!--内容-->
			<div class="result " id="chatContainer">
				<div class="reset" style="min-height: 101%">
					<ul class="chatContent " id="chatContent">

					</ul>
					<p id="resultEnd" class="lh44 t_c">我是有底线的</p>
				</div>
			</div>
			<!--文字-->
			<div class="sayBox " id="sayBox">
				<div class="sayTxt" id="sayTxt" style="height:auto">
					<div class="imBtns" id='modalToggle'>
						<i class="iconfont icon-yuyin " id="yuyinBtn"></i>
						<i class="iconfont icon-jisuanqi "></i>
					</div>
					<textarea name="said" type="text" id="saidInput" style="height:36px"></textarea>
					<div class="" id="postVoice">按住 说话</div>

					<div id="emojiBtn" class="imBtns">
						<i class="iconfont icon-biaoqing3" style="font-size: 30px;"></i>
					</div>
					<div class="imBtns" id="menuBtn">
						<i class="iconfont icon-tianjia"></i>
					</div>
					<div class="sendBtn" id="postTxtMsg">发送</div>
				</div>
				<div id="sayMenus" class=" sayMenus">
					<div id="menusBox">
						<ul class="sayMenus">
							<li id="postPic">
								<div class="imBtnsBlock">
									<i class="iconfont icon-tukuxiangce"></i>
								</div>
								<p class="imBtnsTxt">相片</p>
							</li>
							<li id="postPosition">
								<div class="imBtnsBlock">
									<i class="iconfont icon-weizhi"></i>
								</div>
								<p class="imBtnsTxt">位置</p>
							</li>
						</ul>
					</div>

					<div id="emojiBox" class="hidden">
						<div class="mui-slider" id="emojis">

						</div>
					</div>
				</div>
			</div>
			<!--语音-->
			<div id="record">
				<div class="rp">
					<div class="rprogress">
						<div class="rschedule"></div>
					</div>
					<br/>
				</div>
				<p class="recordTxt" id="audioTxt">录音中...</p>
				<p class="recordTxt2">向上滑动取消录音</p>
			</div>
		</div>
		<!--聊天对象模板-->
		<script id="chatMember" type="text/template">
			{{each list value i}}
			<li class="mui-table-view-cell mui-media ">
				<div class="mui-slider-right ">
					<a class="mui-btn mui-btn-red delect" style="transform: translate(-180px, 0px);" data-userid={{value.targetId}}>删除</a>
				</div>
				<div class="mui-slider-handle listItem" id={{ 'fdBox'+value.targetId}} style="transform: translate(0px, 0px);" data-userid={{value.targetId}} data-avatar={{value.avatar}} data-nickname={{value.nickName}} data-key={{i}}>
					<div class="mui-media-object mui-pull-left listPic ">
						<img src={{value.avatar}} id={{ 'fdAvatar'+value.targetId}}>
						<span class="newsTip" id={{'fdRed'+value.targetId}} ></span>
					</div>
					<div class="mui-media-body listtxt">
						<div>
							<span id={{ 'fdName'+value.targetId}}>{{value.nickName}}</span>
							<span id={{ 'fdTime'+value.targetId}} class="time">--:--</span>
						</div>
						<p class='mui-ellipsis' id={{ 'fdTxt'+value.targetId}}></p>
					</div>
				</div>
			</li>
			{{/each}}
		</script>
		<!--聊天内容模板-->
		<script id="chatList" type="text/template">

			<% for(var i in ListInfo){ var item=ListInfo[i];  %>
			<% if(i%10 === 0 ) { %>
			<li class="t_c flex">
				<div class="timeTip">
					<%= getLocalTime(item.sentTime) %>
				</div>
			</li>
			<% } %>
			<li class="msgList flex <%= (item.messageDirection==1?'me':'') %>">
				<aside class="msgAvatar">
					<%  if(item.messageDirection == 1){%>
					<img src="<%= myAvatar%>" alt="" class="cover" />
					<% } else{ %>
					<img src="<%= targetAvatar%>" alt="" class="cover" />
					<% } %>
				</aside>
				<article class="msgContent f1">
					<% if(item.messageType=="TextMessage" ) { %>
					<div class="txtMsg contentBox">
						<%= emoji.symbolToHTML(item.content.content)%>
					</div>
					<% } else if(item.messageType=="ImageMessage" ) { %>
					<div class="picMsgBox contentBox">
						<img class="contain picMsg" src="<%=(item.content.imageUri)%>" alt="图片丢失" />
					</div>

					<% } else if(item.messageType=="VoiceMessage" ) { %>
					<div class="voiceMsg voiBox contentBox <%= (item.content.extra.isNew?'newVoice':'') %>" data-voicedata="<%= item.content.content %>" data-voicekey="<%= item.messageUId %>">
						<span class="mui-icon mui-icon-mic" style="font-size: 18px;font-weight: bold;"></span>
						<span class="play-state">点击播放</span>
					</div>
					<% }else if(item.messageType=="LocationMessage"){ %>
					<div class="posMsg flex contentBox" dstlo="<%= item.content.longitude %>" dstla="<%= item.content.latitude%>" poi="<%= item.content.poi %>">
						<img class="mapPre" src="../../../images/m.jpg" />
						<div class="posTxt f1">
							<%=(item.content.poi)%>
						</div>
					</div>
					<% } %>
				</article>

			</li>
			<% } %>
			<!--<li class="timeTip t_c"><%= ListInfo[ListInfo.length -1 ].sentTime %></li>-->
		</script>

		<script src="../../../js/bscroll.min.js"></script>
		<script src="../../../js/app.js"></script>
		<script src="../../../js/db.js"></script>

		<script type="text/javascript">
			mui.init({
				swipeBack: true,
				gestureConfig: {
					tap: true, //默认为true
					doubletap: false, //默认为false
					longtap: false, //默认为false
					swipe: true, //默认为true
					drag: true, //默认为true
					hold: true, //默认为false，不监听
					release: true //默认为false，不监听
				}
			});

			var ui = {
				blockList: document.getElementById('block_list'), //列表页面
				blockChat: document.getElementById('block_chat'), //聊天详情页面

				modalToggle: document.getElementById('modalToggle'),
				postTxtMsg: document.getElementById('postTxtMsg'),
				postPic: document.getElementById('postPic'),
				postPosition: document.getElementById('postPosition'),
				sayBox: document.getElementById('sayBox'),
				sayTxt: document.getElementById('sayTxt'),
				sayMenus: document.getElementById('sayMenus'),
				chatContent: document.getElementById('chatContent'),
				textArea: document.getElementById('saidInput'),
				record: document.getElementById('record'),
				audioTxt: document.getElementById('audioTxt'),
				postVoice: document.getElementById('postVoice'),
				hidden: document.getElementById('hidden'),
				resultTop: document.getElementById('resultTop'),
				yuyinBtn: document.getElementById('yuyinBtn'),
				//	表情部分
				emojis: document.getElementById('emojis'),
				emojiBtn: document.getElementById('emojiBtn'),
				emojiBox: document.getElementById('emojiBox'),
				// 菜单按钮
				menuBtn: document.getElementById('menuBtn'),
				menusBox: document.getElementById('menusBox'),

				//				无数据提示
				noRest: document.getElementById('noRest')
			};
			var pageIndex = 1; //当前页码	
			var friends; //最近聊天列表

			//	全局变量		
			var myAvatar; //	wode头像
			var myNickName = '';
			var IMtoken; //我的融云token
			var myId; //我的融云ID

			var ImStaus = false;
			var r = null; //储存mui录音对象、
			var p = null; //语音播放对象
			var s_time; //语音开始时间
			var e_time; //语音结束时间
			var onHolding = false;
			var onSpeaking = false; //当前是否在有效说话
			var time = null; //储存时间函数
			var reset = false; //是否撤销当前消息

			var longitude = ""; //当前位置经度
			var latitude = ""; //当前位置纬度
			var poi = ""; //当前位置文字描述

			var isPlaying = false; //当前是否在播放语音，同时只允许播放一条语音
			var plaingVoice = null; //正在播放的声音（取消播放样式用的）
			var isLoading = false; //正在加载一次数据中

			var realHisRecords = []; //真实渲染的记录

			var isHome = true; //判断是否在前台

			var linking; //判断链接状态

			var onChatPage = false; //是否处于聊天内容页面

			var wrapper; //聊天对象scroll  
			var scroll; //聊天内容scroll  

			var TargetChat = {}; //当前聊天的对象

			var connecting = false;

			mui.plusReady(function() {

				IMtoken = plus.storage.getItem('IMtoken');

				//初始化IM
				initIM();
				//   初始化scroll	
				initScroll();

				var wv = plus.webview.currentWebview();

				var toChat = function toChat() {};

				//	点击进入聊天详情页
				mui('#listInfoBox').on('tap', '.listItem', function() {
					TargetChat.userid = this.dataset.userid;
					TargetChat.avatar = this.dataset.avatar;
					TargetChat.nickName = this.dataset.nickname;
					//					alert(this.dataset.nickname)
					//					去掉红点
					var m = document.getElementById('fdRed' + TargetChat.userid);
					m.style.display = 'none';
					m.innerText = 0;

					ui.blockChat.style.display = 'block';
					onChatPage = true;
					//					初始化聊天对象的聊天记录
					initChatContent();
				});
				//				系统消息页面
				mui('#listInfoBox').on('tap', '.sysItem', function() {
					mui.openWindow({
						url: './sysMessage.html',
						id: 'sysMessage',
						styles: {
							top: '0px', //新页面顶部位置
							bottom: '0px', //新页面底部位置
							scrollIndicator: "none",
							plusrequire: 'ahead',
							// 窗口参数 参考5+规范中的WebviewStyle,也就是说WebviewStyle下的参数都可以在此设置
							titleNView: { // 窗口的标题栏控件
								autoBackButton: true, // 标题栏文字,当不设置此属性时，默认加载当前页面的标题，并自动更新页面的标题
								titleColor: "#fff", // 字体颜色,颜色值格式为"#RRGGBB",默认值为"#000000"
								titleSize: "14px", // 字体大小,默认17px
								backgroundColor: "#151515", // 控件背景颜色,颜色值格式为"#RRGGBB",默认值为"#F7F7F7"
								progress: { // 标题栏控件的进度条样式
									color: "#ccaa42", // 进度条颜色,默认值为"#00FF00"  
									height: "2px" // 进度条高度,默认值为"2px"         
								},
								splitLine: { // 标题栏控件的底部分割线，类似borderBottom
									color: "#404040", // 分割线颜色,默认值为"#CCCCCC"  
									height: "1px" // 分割线高度,默认值为"2px"
								}
							}
						},
						createNew: true, //是否重复创建同样id的webview，默认为false:不重复创建，直接显示
						show: {
							autoShow: true, //页面loaded事件发生后自动显示，默认为true
							duration: 300 //页面动画持续时间，Android平台默认100毫秒，iOS平台默认200毫秒；
						},
						extras: {},
						waiting: {
							autoShow: true, //自动显示等待框，默认为true
							title: '正在加载...' //等待对话框上显示的提示内容
						}
					});
				});
				//				//				点击删除
				mui('#listInfoBox').on('tap', '.delect', function() {
					//					var fdId = this.getAttribute('userid');
					var fdId = this.dataset.userid;

					//					删除操作	
					var li = this.parentNode.parentNode;
					mui.swipeoutClose(li);
					li.parentNode.removeChild(li);
					DB.delectData(fdId);
				});
				//				返回判断
				var old_back = mui.back;
				mui.back = function(event) {
					if(onChatPage) {
						ui.blockChat.style.display = 'none';
						onChatPage = false;
						return;
					}
					old_back();
					return false;
				};
			});
			//			初始化下拉框
			function initScroll(callback) {
				//	聊天内容的scroll
				scroll = new BScroll(document.getElementById('chatContainer'), {
					click: true,
					swipeBounceTime: 400,
					probeType: 3,
					bounceTime: 200,
					resizePolling: 60,
					pullDownRefresh: {
						threshold: 50,
						stop: 0
					}
				});

				scroll.on('pullingDown', function(pos) {
					//					plus.nativeUI.showWaiting();
					getHisContent()
				});
			}
			//			聊天页面返回到列表页
			function backList() {
				//				若不处于聊天页面，则不做处理
				if(!onChatPage) return;
				//				若处于聊天页面,就关闭
				onChatPage = false;
				ui.blockChat.style.display = 'none';
			}
			//			初始化聊天内容记录
			function initChatContent() {
				realHisRecords = [];
				getHisContent(true)
			}
			//			获取某对象的历史信息
			function getHisContent(b) {
				//b  若是新的聊天对象则清空 realHisRecords
				var timestrap = null; // 默认传 null，若从头开始获取历史消息，请赋值为 0 ,timestrap = 0;
				if(b === true) {
					//					重头开始获取					
					timestrap = 0
				}
				//				console.log(TargetChat.userid )
				var conversationType = RongIMLib.ConversationType.PRIVATE; //单聊,其他会话选择相应的消息类型即可。
				var targetId = TargetChat.userid; // 想获取自己和谁的历史消息，targetId 赋值为对方的 Id。			
				var count = 10; // 每次获取的历史消息条数，范围 0-20 条，可以多次获取。
				RongIMLib.RongIMClient.getInstance().getHistoryMessages(conversationType, targetId, timestrap, count, {
					onSuccess: function(list, hasMsg) {
						//				  	console.log(hasMsg)
						if(!hasMsg) {
							//						没有数据了
							mui.toast('没有数据了')
						}
						realHisRecords = list.concat(realHisRecords);
						render(function() {
							scroll.finishPullDown();
						})
					},
					onError: function(error) {
						console.log("GetHistoryMessages,errorcode:" + error);
					}
				});
			}

			//			直接进入聊天页面
			function initHis(id, name, avatar) {
				TargetChat.userid = id;
				TargetChat.avatar = avatar;
				TargetChat.nickName = name;
				//				alert(name)
				var data = {
					targetId: id,
					avatar: avatar,
					nickName: name,
				}

				//					initChatList(function() {
				initChatContent();
				ui.blockChat.style.display = 'block';
				onChatPage = true;
				//					});
				//				
			}
			//	刷新最近聊天的对象列表
			function initChatList(callback) {
				//				console.log('刷新列表')
				//				获取聊天对象接口
				DB.getMemberList(function(res) {
					//					console.log(res.length)
					friends = {
						list: res,
						time: function time(str) {
							return new Date(str).Format('MM-dd hh:mm:ss');
						}
					};
					renderChatList(callback);
				});
			}
			//			渲染聊天对象
			function renderChatList(callback) {
				var html = template('chatMember', friends);
				document.getElementById('listInfo').innerHTML = html;
				if(callback) callback();
			}
			//初始化IM
			function initIM() {

				r = plus.audio.getRecorder(); //储存mui录音对象、
				myAvatar = plus.storage.getItem('pic_head') ? plus.storage.getItem('pic_head') : '../../../images/default_avatar.jpg';
				myNickName = plus.storage.getItem('userNickName');
				myId = plus.storage.getItem('myId');

				self = plus.webview.currentWebview();
				//				测试token
				RongIMLib.RongIMClient.init("bmdehs6pbrcis");
				//	服务器链接监听
				RongIMClient.setConnectionStatusListener({
					onChanged: function onChanged(status) {
						switch(status) {
							case RongIMLib.ConnectionStatus.CONNECTED:
								console.log('链接成功');
								plus.nativeUI.closeWaiting();
								connecting = true;
								break;
							case RongIMLib.ConnectionStatus.CONNECTING:
								console.log('正在链接');
								break;
							case RongIMLib.ConnectionStatus.DISCONNECTED:
								console.log('断开连接');
								connecting = false;
								reConnect();
								break;
							case RongIMLib.ConnectionStatus.KICKED_OFFLINE_BY_OTHER_CLIENT:
								console.log('其他设备登录');
								break;
							case RongIMLib.ConnectionStatus.DOMAIN_INCORRECT:
								console.log('域名不正确');
								break;
							case RongIMLib.ConnectionStatus.NETWORK_UNAVAILABLE:
								console.log('网络不可用');
								plus.nativeUI.closeWaiting();
								connecting = false;
								//								plus.nativeUI.alert('请检查网络');

								reConnect();
								break;
						}
					}
				});

				// 初始化 表情
				RongIMLib.RongIMEmoji.init();
				var ulDom = document.createElement('ul');
				ulDom.classList.add('emojiSlider');
				var list = RongIMLib.RongIMEmoji.list;
				list.map(function(item, index) {
					var li = document.createElement('li');
					li.classList.add('emojiItem');
					li.appendChild(item.node);
					emojis.appendChild(li);
				});
				template.defaults.escape = false;
				// 消息监听器
				RongIMClient.setOnReceiveMessageListener({
					// 接收到的消息 
					onReceived: function onReceived(message) {
						// 判断消息类型 
						switch(message.messageType) {
							//		接收到文本 
							case RongIMClient.MessageType.TextMessage:
								// message.content.content => 消息内容
								//console.log(JSON.stringify(message))
								//								alert(0)
								receiveMsg(message);
								break;
							case RongIMClient.MessageType.VoiceMessage:
								// 对声音进行预加载                
								// message.content.content 格式为 AMR 格式的 base64 码				
								//100毫秒滚动到顶
								receiveMsg(message, true);
								break;
								//收到图片信息	
							case RongIMClient.MessageType.ImageMessage:
								//						console.log(JSON.stringify(message))
								// message.content.content => 图片缩略图 base64。
								// message.content.imageUri => 原图 URL。
								receiveMsg(message);
								break;
								//					收到定位消息	
							case RongIMClient.MessageType.LocationMessage:
								// message.content.latiude => 纬度。
								// message.content.longitude => 经度。
								// message.content.content => 位置图片 base64。
								receiveMsg(message);
								break;
							case RongIMClient.MessageType.RichContentMessage:
								break;
							case RongIMClient.MessageType.InformationNotificationMessage:
								// do something...
								break;
							case RongIMClient.MessageType.ContactNotificationMessage:
								// do something...
								break;
							case RongIMClient.MessageType.ProfileNotificationMessage:
								// do something...
								break;
							case RongIMClient.MessageType.CommandNotificationMessage:
								// do something...
								break;
							case RongIMClient.MessageType.CommandMessage:
								// do something...
								break;
							case RongIMClient.MessageType.UnknownMessage:
								// do something...
								break;
							default:
								// do something...
						}
					}
				});

				document.addEventListener("resume", function() {
					//					alert(1)
					if(connecting) {
						return;
					} else {
						connectIM();
					}
				}, false);
				//				断线重连
				var reConnect = function reConnect() {
					if(connecting) {
						return;
					}
					var callback = {
						onSuccess: function onSuccess(userId) {
							plus.nativeUI.closeWaiting();
							connecting = true;
						},
						onTokenIncorrect: function onTokenIncorrect() {
							console.log('token无效');
						},
						onError: function onError(errorCode) {}
					};
					var config = {
						// 默认 false, true 启用自动重连，启用则为必选参数
						auto: true,
						token: IMtoken,
						// 重试频率 [100, 1000, 3000, 6000, 10000, 18000] 单位为毫秒，可选
						//			        url: 'cdn.ronghub.com/RongIMLib-2.2.6.min.js',
						url: ' https://cdn.ronghub.com/RongIMLib-2.3.3.min.js',
						// 网络嗅探地址 [http(s)://]cdn.ronghub.com/RongIMLib-2.2.6.min.js 可选
						rate: [100, 1000, 3000, 6000, 10000]
					};
					RongIMClient.reconnect(callback, config);
				};
				//		启用页面事件绑定
				eventInit();
				connectIM();
				//				reConnect()
			}
			//	链接服务器
			function connectIM() {
				// plus.nativeUI.showWaiting('链接中')
				//				alert(IMtoken)
				friends = [];
				RongIMClient.connect(IMtoken, {
					onSuccess: function onSuccess(userId) {

						ImStaus = true;
						connecting = true;
						plus.nativeUI.closeWaiting();
					},
					onTokenIncorrect: function onTokenIncorrect() {
						//						console.log('token无效');
						plus.nativeUI.closeWaiting();
						plus.nativeUI.toast('token无效,请联系平台客服');
					},
					onError: function onError(errorCode) {
						var info = '';
						plus.nativeUI.closeWaiting();

						switch(errorCode) {
							case RongIMLib.ErrorCode.TIMEOUT:
								info = '超时';
								plus.nativeUI.toast(info);
								break;
							case RongIMLib.ConnectionState.UNACCEPTABLE_PAROTOCOL_VERSION:
								info = '不可接受的协议版本';
								plus.nativeUI.toast(info);
								break;
							case RongIMLib.ConnectionState.IDENTIFIER_REJECTED:
								info = 'appkey不正确';
								plus.nativeUI.toast(info);
								break;
							case RongIMLib.ConnectionState.SERVER_UNAVAILABLE:
								info = '服务器不可用';
								plus.nativeUI.toast(info);
								break;
						}
						console.log(errorCode);
					}
				});
				//初始化聊天记录列表
				initChatList();
			}
			//	页面事件监听
			function eventInit() {
				//	切换语音
				ui.modalToggle.addEventListener('tap', function() {
					ui.sayTxt.classList.toggle('AudioModal');
				});

				ui.chatContent.addEventListener('tap', function() {
					ui.sayBox.classList.remove('showMenu');
					ui.textArea.blur();
					if(ui.textArea.value.length <= 0) {
						ui.textArea.style.height = '36px';
					}
				});
				ui.emojiBtn.addEventListener('tap', function() {
					ui.sayBox.classList.add('showMenu');
					ui.emojiBox.classList.add('slideInUp', 'animated');
					ui.emojiBox.classList.remove('hidden');
					ui.menusBox.classList.add('hidden');
					ui.menusBox.classList.remove('slideInUp', 'animated');
				});
				ui.menuBtn.addEventListener('tap', function() {
					ui.sayBox.classList.add('showMenu');
					ui.menusBox.classList.add('slideInUp', 'animated');
					ui.menusBox.classList.remove('hidden');
					ui.emojiBox.classList.add('hidden');
					ui.emojiBox.classList.remove('slideInUp', 'animated');
				});

				//			发送文字消息
				ui.postTxtMsg.addEventListener('tap', function() {
					SendTxtMsg();
				});

				//			发送图片
				ui.postPic.addEventListener('tap', function() {
					SendImgMsg();
				});

				//		监听文本框引起的样式变化
				ui.textArea.addEventListener('tap', function() {

					if(ui.textArea.value.length < 1 || !ui.textArea.value.length) {
						ui.postTxtMsg.style.display = 'none';
						ui.menuBtn.style.display = 'block';
					} else {
						ui.menuBtn.style.display = 'none';
						ui.postTxtMsg.style.display = 'block';
					}
				});

				//		监听文本框引起的样式变化
				ui.textArea.addEventListener('keyup', function() {
					if(ui.textArea.value.length < 1 || !ui.textArea.value.length) {
						ui.postTxtMsg.style.display = 'none';
						ui.menuBtn.style.display = 'block';
					} else {
						ui.sayBox.classList.add('textLine2');

						this.style.height = this.scrollHeight + 'px';
						ui.menuBtn.style.display = 'none';
						ui.postTxtMsg.style.display = 'block';
					}
				});
				//			发送位置
				ui.postPosition.addEventListener('tap', function() {
					mui.openWindow({
						url: './getlocation.html',
						id: 'getlocation',
						styles: {
							top: '0px', //新页面顶部位置
							bottom: '0px', //新页面底部位置
							scrollIndicator: "none",
							plusrequire: 'ahead'
						},
						createNew: true, //是否重复创建同样id的webview，默认为false:不重复创建，直接显示
						show: {
							autoShow: false, //页面loaded事件发生后自动显示，默认为true
							duration: 300 //页面动画持续时间，Android平台默认100毫秒，iOS平台默认200毫秒；
						},
						waiting: {
							autoShow: true, //自动显示等待框，默认为true
							title: '正在加载...' //等待对话框上显示的提示内容
						}
					});
				});

				//			点击选中表情表情
				mui('#emojis').on('tap', '.rong-emoji-content', function() {
					ui.textArea.value += this.getAttribute('name');
					mui('#emojiSheet').popover('toggle');
				});

				//				录音长按
				ui.postVoice.addEventListener('hold', function() {
					if(plaingVoice) plaingVoice.classList.remove('playing');
					if(onHolding || !ImStaus) return;
					if(p) p.stop();
					onHolding = true;
					ui.audioTxt.innerText = '稍等片刻';
					ui.record.style.display = 'block';
					s_time = new Date().getTime();
					time = setTimeout(function() {
						plus.device.vibrate(300);
						onSpeaking = true;
						startAudio();
					}, 1200);
				});
				//		向上滑动取消
				document.body.addEventListener("drag", function(event) {
					if(!onSpeaking) {
						return false;
					} else {
						if(Math.abs(event.detail.deltaY) >= 150) {
							reset = true;
							mui.later(function() {
								record.style.display = 'none';
							}, 500);
						}
					}
				});

				//				放开录音
				ui.postVoice.addEventListener('release', function(e) {
					e_time = new Date().getTime();
					if(e_time - s_time < 1200) {
						clearTimeout(time);
						time = null;

						ui.audioTxt.innerText = '说话时间太短';
						mui.later(function() {
							record.style.display = 'none';
							onHolding = false;
						}, 500);
					} else {
						if(reset) {
							ui.audioTxt.innerText = '消息撤回';
						} else {
							ui.audioTxt.innerText = '准备发送';
						}
						setTimeout(function() {
							onSpeaking = false;
							stopAudio();
						}, 1000);
					}
				});

				//				点击语音播放
				mui('#chatContent').on('tap', '.voiceMsg', function() {
					if(p) p.stop();
					this.classList.add('playing');

					this.classList.remove('newVoice');
					var voice = this.dataset.voicedata;
					var key = this.dataset.voicekey;

					playAudio(voice, function() {})

				});

				//            点击图片预览
				mui('#chatContent').on('tap', '.picMsg', function() {
					var url = this.getAttribute('src');
					url = url.replace('_mini', '_small');
					//					console.log(url)
					plus.nativeUI.previewImage(url, {});
				});
				//            点击位置预览图打开第三方定位
				mui('#chatContent').on('tap', '.posMsg', function() {
					var dstlo = this.getAttribute('dstlo');
					var dstla = this.getAttribute('dstla');
					var poi = this.getAttribute('poi');

					mui.openWindow({
						url: './mapPre.html',
						id: 'mapPre',
						styles: {
							top: '0px', //新页面顶部位置
							bottom: '0px', //新页面底部位置
							scrollIndicator: "none",
							plusrequire: 'ahead'
						},
						createNew: true, //是否重复创建同样id的webview，默认为false:不重复创建，直接显示
						show: {
							autoShow: false, //页面loaded事件发生后自动显示，默认为true
							duration: 300 //页面动画持续时间，Android平台默认100毫秒，iOS平台默认200毫秒；
						},
						extras: {
							dstlo: dstlo,
							dstla: dstla,
							poi: poi
						},
						waiting: {
							autoShow: true, //自动显示等待框，默认为true
							title: '正在加载...' //等待对话框上显示的提示内容
						}
					});
				});

				//		页面返回参数变化
				mui('.mui-bar').on('tap', '.mui-action-back', function() {
					onChatPage = false;
					plus.webview.currentWebview().hide();
				});
			}

			//	发送文字消息
			function SendTxtMsg() {
				if(!ui.textArea.value || ui.textArea.value.length < 1) {
					mui.toast('请输入内容！');
					return;
				}
				//				alert('!!!'+TargetChat.nickName)
				var msg = new RongIMLib.TextMessage({
					content: ui.textArea.value,
					extra: {
						pro: '',
						KHavatar: TargetChat.avatar,
						SHavatar: myAvatar,
						KHnickName: TargetChat.nickName,
						SHnickName: myNickName
					}
				});
				//				console.log(TargetChat.nickName)
				var conversationtype = RongIMLib.ConversationType.PRIVATE; // 单聊,其他会话选择相应的消息类型即可。
				SendMsg(conversationtype, TargetChat.userid, msg, function(message) {
					createHistory(message);
					addHisType(message);
					ui.menuBtn.style.display = 'block';
					ui.postTxtMsg.style.display = 'none';
					ui.textArea.blur();

					ui.textArea.style.height = '36px';
					ui.textArea.value = '';
				});
			}
			//	发送图片信息
			function SendImgMsg() {
				if(mui.os.plus) {
					var buttonTit = [{
						title: "拍照"
					}, {
						title: "从手机相册选择"
					}];

					plus.nativeUI.actionSheet({
						title: "选择图片",
						cancel: "取消",
						buttons: buttonTit
					}, function(b) {
						/*actionSheet 按钮点击事件*/
						switch(b.index) {
							case 0:
								break;
							case 1:
								getImage(); /*拍照*/
								break;
							case 2:
								galleryImg(); /*打开相册*/
								break;
							default:
								break;
						}
					});
				}
			}

			//拍照获取相片
			function getImage() {
				plus.camera.getCamera().captureImage(function(e) {
					//					plus.nativeUI.showWaiting('发送中...')
					plus.io.resolveLocalFileSystemURL(e, function(entry) {

						var path = entry.toLocalURL();
						var fileArr = [path];

						uploadFn(fileArr, function() {
							plus.nativeUI.closeWaiting();
						});
						//	                        console.log(path);              
					}, function(e) {
						mui.toast("读取拍照文件错误：" + e.message);
					});
				});
			}

			//从相册选择图片
			function galleryImg() {
				plus.gallery.pick(function(e) {
					var fileArr = [];
					for(var i in e.files) {
						var fileSrc = e.files[i];
						//				console.log(fileSrc);
						fileArr.push(fileSrc);
					}

					uploadFn(fileArr, function() {
						plus.nativeUI.closeWaiting();
					});
				}, function(e) {
					console.log("取消选择图片");
				}, {
					filter: "image",
					multiple: true,
					maximum: 3,
					system: false,
					onmaxed: function onmaxed() {
						plus.nativeUI.alert('最多只能选择3张图片');
					}
				});
			}
			//			base64
			function getBase64Image(src, callback) {
				var img = new Image();
				img.src = src;
				img.onload = function() {
					var canvas = document.createElement("canvas");
					var radio = img.width / img.height;
					canvas.width = 1000;
					canvas.height = canvas.width / radio;

					var ctx = canvas.getContext("2d");
					ctx.drawImage(img, 0, 0, canvas.width, canvas.height); //使用画布画图

					var ext = img.src.substring(img.src.lastIndexOf(".") + 1).toLowerCase(); //动态截取图片的格式

					var dataURL = canvas.toDataURL("image/jpg", 0.5); //返回的是一串Base64编码的URL并指定格式

					if(callback) callback(dataURL);
				};
			}
			//模拟图片上传操作
			function uploadFn(arr, callback) {
				var base64Str = "base64";

				var conversationtype = RongIMLib.ConversationType.PRIVATE; // 单聊,其他会话选择相应的消息类型即可。

				for(var i = 0; i < arr.length; i++) {
					var imageUri = arr[i];

					getBase64Image(imageUri, function(url) {
						//											console.log(url)
						var ext = imageUri.substring(imageUri.lastIndexOf(".") + 1).toLowerCase();
						url = url.substr(22);
						plus.nativeUI.showWaiting();
						var Info = {
							image_base64: url,
							file_name: '.' + ext,
							foldName: plus.storage.getItem('userName'),
							size: 3
							//							isPrj: false,

						};
						mui.ajax(app.baseUrl + '/api/Upload/UploadByBase64', {
							data: Info,
							dataType: 'json', //服务器返回json格式数据
							type: 'post', //HTTP请求类型
							timeout: 10000, //超时时间设置为10秒；
							headers: {
								'Content-Type': 'application/json'
							},
							success: function success(result) {
								//															console.log(result.Data)
								if(result.Success) {
									var msg = new RongIMLib.ImageMessage({
										content: 'base64 格式缩略图',
										imageUri: result.Data,
										extra: {
											pro: '',
											//											SHavatar: TargetChat.avatar,
											//											KHavatar: myAvatar,
											//											SHnickName: TargetChat.nickName,
											//											KHnickName: myNickName
											KHavatar: TargetChat.avatar,
											SHavatar: myAvatar,
											KHnickName: TargetChat.nickName,
											SHnickName: myNickName
										}
									});
									SendMsg(conversationtype, TargetChat.userid, msg, function(message) {
										createHistory(message);
										addHisType(message);
										callback();
										ui.sayBox.classList.remove('showMenu');
									});
								} else {
									//								alert(result.Msg)
								}

								plus.nativeUI.closeWaiting();
							},
							error: function error(xhr, type, errorThrown) {
								plus.nativeUI.closeWaiting();
								plus.nativeUI.toast('网络不佳，图片上传失败');
								//				alert(type)
							}
						});
					});
				}
			}
			//	发送位置信息
			function SendPositionMsg(location) {
				//				console.log(JSON.stringify(location))
				plus.nativeUI.showWaiting('发送中...');
				var content = "位置缩略图";
				location.content = content;
				location.extra = {
					pro: '',
					//					SHavatar: TargetChat.avatar,
					//					KHavatar: myAvatar,
					//					SHnickName: TargetChat.nickName,
					//					KHnickName: myNickName
					KHavatar: TargetChat.avatar,
					SHavatar: myAvatar,
					KHnickName: TargetChat.nickName,
					SHnickName: myNickName
				};
				var msg = new RongIMLib.LocationMessage(location);
				var conversationtype = RongIMLib.ConversationType.PRIVATE;

				SendMsg(conversationtype, TargetChat.userid, msg, function(message) {
					createHistory(message);
					addHisType(message);
					plus.nativeUI.closeWaiting();
					sayBox.classList.remove('showMenu');
				});
			}

			//	开始录制语音信息
			function startAudio() {
				audioTxt.innerText = '录音中...';

				ui.postVoice.innerText = '松开 结束';
				r.record({
					filename: "_doc/audio/",
					format: 'amr'
				}, function(recordFile) {
					// 发送录音
					if(!reset) {
						sendVoice(recordFile);
					} else {
						audioTxt.innerText = '语音撤回';
						reset = false;
					}
				}, function(e) {
					alert("Audio record failed: " + e.message);
				});
			}
			//结束语音
			function stopAudio() {
				r.stop();
				record.style.display = 'none';
				onHolding = false;
				ui.postVoice.innerText = '按住 说话';
			}

			// 发送录音
			function sendVoice(fileUrl) {
				Audio2dataURl(fileUrl, function(content) {
					//					console.log(content)
					var msg = new RongIMLib.VoiceMessage({
						content: content,
						extra: {
							pro: '',
							//							SHavatar: TargetChat.avatar,
							//							KHavatar: myAvatar,
							//							SHnickName: TargetChat.nickName,
							//							KHnickName: myNickName
							KHavatar: TargetChat.avatar,
							SHavatar: myAvatar,
							KHnickName: TargetChat.nickName,
							SHnickName: myNickName
						}
					});
					var conversationtype = RongIMLib.ConversationType.PRIVATE; // 单聊,其他会话选择相应的消息类型即可。
					SendMsg(conversationtype, TargetChat.userid, msg, function(message) {
						//						console.log(JSON.stringify(message))
						createHistory(message);
						addHisType(message);
					});
				});
			}
			//	语音文件转化成base64	
			function Audio2dataURl(path, callback) {
				if(mui.os.android) {
					plus.io.requestFileSystem(plus.io.PRIVATE_DOC, function(fs) {
						fs.root.getFile(path, {
							create: true
						}, function(entry) {
							entry.file(function(file) {

								var reader = new plus.io.FileReader();
								reader.readAsDataURL(file);
								reader.onloadend = function(e) {
									var data = e.target.result;
									callback(data);
								};
							}, function(e) {
								console.log(e);
							});
						});
					});
				} else if(mui.os.ios) {
					plus.io.resolveLocalFileSystemURL(path, function(entry) {
						entry.file(function(file) {
							var reader = new plus.io.FileReader();
							reader.onloadend = function(e) {
								var data = e.target.result;
								callback(data);
							};
							reader.readAsDataURL(file);
						}, function(e) {
							mui.toast("读写出现异常: " + e.message);
						});
					});
				}
			}

			//	播放语音
			function playAudio(voice, callback) {
				dataURL2Audio(voice, function(file) {
					var path = file.toURL();
					p = plus.audio.createPlayer(path);
					p.play(function() {
						callback();
					}, function(e) {
						alert("语音信息不完整");
					});
				});
			}
			//base64传语音文件
			function dataURL2Audio(base64Str, callback) {
				var base64Str = base64Str.replace('data:audio/amr;base64,', '');
				var audioName = new Date().valueOf() + '.amr';

				plus.io.requestFileSystem(plus.io.PRIVATE_DOC, function(fs) {

					fs.root.getFile(audioName, {
						create: true
					}, function(entry) {
						// 获得平台绝对路径
						var fullPath = entry.fullPath;
						if(mui.os.android) {
							debugger;
							// 读取音频
							var Base64 = plus.android.importClass("android.util.Base64");
							var FileOutputStream = plus.android.importClass("java.io.FileOutputStream");
							try {
								var out = new FileOutputStream(fullPath);
								var bytes = Base64.decode(base64Str, Base64.DEFAULT);
								out.write(bytes);
								out.close();
								// 回调 
								callback && callback(entry);
							} catch(e) {
								console.log(e.message);
							}
						} else if(mui.os.ios) {
							var NSData = plus.ios.importClass('NSData');
							var nsData = new NSData();
							nsData = nsData.initWithBase64EncodedStringoptions(base64Str, 0);
							if(nsData) {
								nsData.plusCallMethod({
									writeToFile: fullPath,
									atomically: true
								});
								plus.ios.deleteObject(nsData);
							}
							// 回调
							callback && callback(entry);
						}
					});
				});
			}

			//	发送信息方法
			function SendMsg(conversationtype, targetId, msg, callback) {
				//				console.log(JSON.stringify(msg))	
				callback = callback || null;
				RongIMClient.getInstance().sendMessage(conversationtype, targetId.toString(), msg, {
					onSuccess: function onSuccess(message) {

						if(callback) {

							//							自己发送的信息
//							initChatList();

							callback(message);
							resultFresh(true, true);
						}
					},
					onError: function onError(errorCode, message) {
						var info = '';
						switch(errorCode) {
							case RongIMLib.ErrorCode.TIMEOUT:
								info = '超时';
								plus.nativeUI.toast('链接失败，请检查网络');
								break;
							case RongIMLib.ErrorCode.UNKNOWN_ERROR:
								info = '未知错误';
								plus.nativeUI.toast('链接失败，请检查网络');
								break;
							case RongIMLib.ErrorCode.REJECTED_BY_BLACKLIST:
								info = '在黑名单中，无法向对方发送消息';
								plus.nativeUI.toast('链接失败，请检查网络');
								break;
							case RongIMLib.ErrorCode.NOT_IN_DISCUSSION:
								info = '不在讨论组中';

								break;
							case RongIMLib.ErrorCode.NOT_IN_GROUP:
								info = '不在群组中';
								break;
							case RongIMLib.ErrorCode.NOT_IN_CHATROOM:
								info = '不在聊天室中';
								break;
							default:
								info = x;
								break;
						}
					}
				});
			}

			//	每次收发消息触发scroll更新
			function resultFresh(ismine, ifFresh) {
				scroll.refresh();
				if(ifFresh) {
					//是否需要自动下拉

					scroll.scrollToElement(document.getElementById('resultEnd'), 300, 0, 0, 'ease-in');
				}
			}
			//	历史记录本地储存
			function createHistory(message) {
				message.belong = myId;
				DB.addMember(message)
			}

			//  渲染条目
			function render(callback) {

				var l = {};

				l.targetAvatar = TargetChat.avatar;
				l.myAvatar = myAvatar ? myAvatar : '../../../images/default_avatar.jpg';
				l.ListInfo = realHisRecords;
				l.emoji = RongIMLib.RongIMEmoji;
				l.getLocalTime = getLocalTime

				var html = template('chatList', l);
				document.getElementById('chatContent').innerHTML = html;
				scroll.refresh();
				if(callback) callback()
			}

			//	接受信息,所处反应
			function receiveMsg(message) {
				if(isHome) {
					//					当app处在前台
					plus.device.vibrate(300);
				} else {
					//					console.log(JSON.stringify(message))
					var t = message.messageType;
					switch(t) {
						case 'TextMessage':
							var msg = {
								title: message.content.extra.KHnickName,
								content: message.content.content
							};
							app.createLocalPushMsg(message);
							break;
						default:
							var msg = {
								title: message.content.extra.KHnickName,
								content: '您收到一条新的对话'
							};
							app.createLocalPushMsg(msg);
							break;
					}
				}
				//				判断是语音信息是否是已读
				if(message.messageType == 'VoiceMessage') {
					message.content.extra.isNew = true;
				}
				//				服务器备份
				backups(message);
				//				创建本地记录	
//				

				//				判断不是当前对象的聊天信息,则会产生红点新消息
				if(!onChatPage || message.senderUserId != TargetChat.userid) {
					//					列表页产生红点提示
					hintNewMsg(message);
					return false;
				}
				realHisRecords.push(message);
				render();
			}
			//			服务器备份数据
			function backups(message) {
				mui.ajax(app.baseUrl + '/api/ChatRY/Save', {
					type: 'post', //HTTP请求类型
					timeout: 5000, //超时时间设置为10秒；
					headers: {
						'Content-Type': 'application/x-www-form-urlencoded'
					},
					success: function success(result) {
						console.log('备份成功');
					},
					error: function error(xhr, type, errorThrown) {
						//									app.catchErr(type)
					}
				});
			}
			//			获取到地图选址的回调
			function getLocation(location) {
				document.getElementById('sayBox').classList.remove('showMenu');
				SendPositionMsg(location);
			}
			//			添加信息
			function addHisType(message) {
				realHisRecords.push(message);
				render();
			}

			function refresh() {
				myAvatar = plus.storage.getItem('pic_head');
				myNickName = plus.storage.getItem('userNickName');
				myId = plus.storage.getItem('myId');
				ImInit();
			}

			Date.prototype.Format = function(fmt) {
				var o = {
					"M+": this.getMonth() + 1, // 月份
					"d+": this.getDate(), // 日
					"h+": this.getHours(), // 小时
					"m+": this.getMinutes(), // 分
					"s+": this.getSeconds(), // 秒
					"q+": Math.floor((this.getMonth() + 3) / 3), // 季度
					"S": this.getMilliseconds() // 毫秒
				};
				if(/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
				for(var k in o) {
					if(new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, RegExp.$1.length == 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length));
				}
				return fmt;
			};

			function getLocalTime(timestamp) {
				var date = new Date(timestamp); //时间戳为10位需*1000，时间戳为13位的话不需乘1000
				var Y = date.getFullYear() + '-';
				var M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '-';
				var D = date.getDate() + ' ';
				var h = date.getHours() + ':';
				var m = date.getMinutes() + ':';
				var s = date.getSeconds();

				return Y + M + D + h + m + s;
			}
			//	接收到对方消息,列表页消息提示变化红点提示
			function hintNewMsg(data) {
				var getor = data.senderUserId;
				var time;
				var text;
				var box = document.getElementById('fdBox' + getor);
				
//				首页显示红点
				plus.webview.getWebviewById('home').evalJS('newMsg()')
				
				
				if(box) {
					//					已经存在的聊天对象
					time = document.getElementById('fdTime' + getor);
					text = document.getElementById('fdTxt' + getor);

					time.innerText = new Date().Format("yyyy-MM-dd hh:mm:ss");

					if(data.messageType == 'TextMessage') {
						text.innerText = data.content.content;
					} else if(data.messageType == 'LocationMessage') {
						text.innerText = '向您发送了位置';
					} else if(data.messageType == 'VoiceMessage') {
						text.innerText = '语音信息';
					} else {
						text.innerText = '图片';
					}
					var m = document.getElementById('fdRed' + getor);
				
					if(!m.innerText){
						m.innerText = 1;
					}else{
						m.innerText = parseInt(m.innerText) + 1;
					}
					
	
					m.style.display = 'block';
					
				} else { 
					//					表示是新的聊天天对象
					
					createHistory(data);
					
//					renderChatList(function() {
//						var m = document.getElementById('fdRed' + getor);
//						if(!m) return;
//						m.innerText = 1;
//						time = document.getElementById('fdTime' + getor);
//						text = document.getElementById('fdTxt' + getor);
//
//						time.innerText = new Date().Format("yyyy-MM-dd hh:mm:ss");
//
//						if(data.messageType == 'TextMessage') {
//							text.innerText = data.content.content;
//						} else if(data.messageType == 'LocationMessage') {
//							text.innerText = '向您发送了位置';
//						} else if(data.messageType == 'VoiceMessage') {
//							text.innerText = '语音信息';
//						} else {
//							text.innerText = '图片';
//						}
//						m.style.display = 'block';
//					});
				}
			}
			//			系统新消息产生红点提示
			function redSet(msg) {
				var m = document.getElementById('sysRed');
				m.style.display = 'block';
				m.innerText = parseInt(m.innerText) + 1;

				var t = document.getElementById('sysTime');
				t.innerText = new Date().Format('MM-dd hh:mm:ss');

				var c = document.getElementById('sysTxt');
				c.innerText = msg;
			}
			//			去除系统新消息
			function redClean(msg) {
				var m = document.getElementById('sysRed');
				m.style.display = 'none';
				m.innerText = 0;
			}
		</script>
	</body>

</html>