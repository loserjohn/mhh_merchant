<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>发布新作品</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../../css/common.css" />
		<link rel="stylesheet" href="../../../css/iconfont.css" />
		<style>
			.btns {
				margin-top: 15px;
			}
			
			.btns .cm_btn {
				height: auto;
			}
			
			.msgBox {
				/*background: red;*/
				width: 100%;
			}
			
			.msgBox .avatar {
				width: 56px;
				height: 56px;
				border-radius: 0;
				margin-right: 10px;
			}
			
			.msgBox .mui-table-view-cell {
				/*height: 78px;*/
			}
			
			.msgBox .iconfont,
			.msgBox .cellName {
				/*line-height: 50px;*/
				font-size: 16px;
				margin-right: 10px;
			}
			
			.msgBox .cellInputTxt {
				width: 50%;
				border: none;
				outline: none;
				/*line-height: 56px;*/
				margin: 0;
				padding: 0;
				text-align: right;
				height: auto;
			}
			
			.msgBox .seletBox {
				width: 50%;
				border: none;
				outline: none;
				/*line-height: 56px;*/
				margin: 0;
				padding: 0;
				text-align: right;
				height: auto;
				position: absolute;
				top: 0;
				right: 0;
				height: 100%;
				opacity: 0;
			}
			
			.msgBox .cellInputArea {
				border: none;
				outline: none;
				padding: 0;
				min-height: 100px;
			}
			
			.msgBox .cellInputTxt select {
				background: green;
				text-align: right;
			}
			
			.msgBox .checkitem {
				padding: 15px 20px;
			}
			
			.msgBox .mui-input-group .checks {
				top: 11px;
			}
			
			.msgBox .mui-input-group {
				margin: 0;
			}
			
			.msgBox .picPreBox {
				justify-content: space-around;
				box-sizing: border-box;
				padding: 10px;
			}
			
			.msgBox .picPreBox .picPre {
				box-sizing: border-box;
				/*padding: 10px;*/
				width: 46%;
				overflow: hidden;
			}
			
			.tabView {
				min-height: 85%;
				/*background: red;*/
			}
			
			.detailPicBox {
				box-sizing: border-box;
				padding: 15px;
			}
			
			.detailPic {
				justify-content: space-between;
				margin-top: 10px;
			}
			
			.detailPic .detailPicItem {
				width: 32%;
				box-sizing: border-box;
			}
			
			.detailPic .detailPicItem>img {
				width: 100%;
			}
			/*.addTime{
				width: 24px;
				height:24px;
				background: #000000;
				text-align: center;
				line-height: 24px;
				border-radius: 50%;
				color: #ccaa42;
				padding: 0;
			}*/
			
			.addTime {
				margin-left: 20px;
				margin-right: 0!important;
				background: #404040;
				color: #fff;
				padding: 0 10px;
				line-height: 3;
			}
		</style>
	</head>

	<body>
		<div id="app">
			<header class="mui-bar mui-bar-nav " id="header">
				<button class="mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left cor_w"><span class="mui-icon mui-icon-left-nav "></span>返回</button>
				<h1 class="mui-title">{{title}}</h1>
				<a class=" mui-pull-right cor_y fs16" style="line-height: 45px">
					须知
				</a>
			</header>

			<!--新卡信息-->
			<div class="newCardMsg" id="content">
				<div class="msgBox">
					<ul class="mui-table-view">
						<li class="mui-table-view-cell flex">
							<div class="f1 cellName">项目名称：</div>
							<input type="text" class="cellInputTxt" v-model="productName" placeholder="请输入项目名称" />
						</li>
						<li class="mui-table-view-cell flex">
							<div class="f1 cellName ">类型</div>
							<select v-model="productType" class=" t_r red reset seletBox" @change="_updatedMsg(1)">
								<option disabled value="">请选择</option>
								<option v-for="item in productTypeList" :value="item.Text" :key="item.Value">{{item.Text}}</option>
							</select>

							<div class=" cellName">{{productType}}</div>
							<i class="iconfont icon-xiayibu "></i>
						</li>
						<li class="mui-table-view-cell flex">
							<div class="f1 cellName ">项目分类</div>
							<select v-model="productClass" class=" t_r red reset seletBox" @change="_updatedMsg(2)">
								<option disabled value="">请选择</option>
								<option v-for="item in productClassList" :value="item.Text" :key="item.Value">{{item.Text}}</option>
							</select>
							<div class=" cellName">{{productClass}}</div>
							<i class="iconfont icon-xiayibu "></i>
						</li>
						<li class="mui-table-view-cell flex">
							<div class="f1 cellName ">项目标签</div>

							<select v-model="productLabel" class=" t_r red reset seletBox">
								<option disabled value="">请选择</option>
								<option v-for="item in productLabelList" :value="item.Text" :key="item.Value">{{item.Text}}</option>
							</select>
							<div class=" cellName">{{productLabel}}</div>
							<i class="iconfont icon-xiayibu "></i>
						</li>
						<li class="mui-table-view-cell flex">
							<div class="f1 cellName">项目原价</div>
							<input type="number" v-model="originalPrice" class="cellInputTxt" placeholder="金额" />
						</li>
						<li class="mui-table-view-cell flex">
							<div class="f1 cellName">项目折扣价</div>
							<input type="text" v-model="currentPrice" class="cellInputTxt" placeholder="金额" />
						</li>
						<li class="mui-table-view-cell flex">
							<div class="f1 cellName">是否使用打折券</div>
							<div class="mui-switch" :class="{'mui-active':usePlatform}" @tap="_updatedMsg(3)">
								<div class="mui-switch-handle"></div>
							</div>
						</li>
						<!--<li class="mui-table-view-cell flex">
							<div class="f1 cellName">是否参加平台活动</div>
							<div class="mui-switch " :class="{'mui-active':joinPlatform}" @tap="_updatedMsg(4)">
								<div class="mui-switch-handle"></div>
							</div>
						</li>-->
						<li class="mui-table-view-cell flex">
							<div class="f1 cellName">耗时（分钟）</div>
							<input type="number" v-model="consuming" class="cellInputTxt" placeholder="分钟" @change="_updatedMsg(5)" />
						</li>
						<li class="mui-table-view-cell flex">
							<div class="f1 cellName">消耗时段
								<p>(一时段15分钟)</p>
							</div>
							<div class="cellInputTxt">{{time}}</div>
							<i class="iconfont icon-add addTime" @tap="_updatedMsg(6)"></i>

						</li>
						<li class="mui-table-view-cell flex">
							<div class="f1 cellName">维持（天数）</div>
							<input type="number" v-model="holdDay" class="cellInputTxt" placeholder="天数" />
						</li>

						<li class="detailPicBox">
							<div class="f1 cellName ">项目图片</div>
							<div class="flex detailPic">
								<div class=" detailPicItem" @tap="_updatedMsg(7)">
									<img :src="productImg1?productImg1:'../../../images/blank.png'" alt="" />
								</div>
								<div class="detailPicItem" @tap="_updatedMsg(8)">
									<img :src="productImg2?productImg2:'../../../images/blank.png'" alt="" />
								</div>
								<div class=" detailPicItem" @tap="_updatedMsg(9)">
									<img :src="productImg3?productImg3:'../../../images/blank.png'" alt="" />
								</div>
							</div>
						</li>

						<li class="mui-table-view-cell">
							<!--<div class="f1 cellName ">用卡说明</div>-->
							<textarea name="" rows="" cols="" class="cellInputArea" v-model="produtDetail" placeholder="项目详情"></textarea>

						</li>
						<!--<li class="mui-table-view-cell">
							<textarea name="" rows="" cols="" v-model="produtExplain " class="cellInputArea" placeholder="项目说明">		            		
				            	</textarea>

						</li>-->
					</ul>
				</div>
			</div>

			<div class="btns container flex">
				<div class="f1">
					<div class="cm_btn" @tap="_submit">
						{{btn}}
					</div>
				</div>

			</div>

		</div>
		<script src="../../../js/mui.min.js"></script>
		<script src="../../../js/app.js"></script>
		<script src="../../../js/vue.js"></script>
		<script src="../../../js/aes.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../../js/imgClip.js"></script>

		<script type="text/javascript">
			mui.init({
				swipeBack: true
			})
			var APP
			mui.plusReady(function() {
				app.WXinit(CryptoJS)
				APP = new Vue({
					el: '#app',
					data: {
						title: '发布新作品',
						btn: '确认添加',
						dstProduct: '',

						productName: '', //项目名字
						productType: '', //类型
						productTypeList: '',
						productClass: '', //项目分类
						productClassList: '',
						productLabel: '', //项目标签
						productLabelList: '',
						originalPrice: '', //原价
						currentPrice: '', //现价
						usePlatform: false, //是否使用平台活动
						//						joinPlatform: false, //是否参加平台活动
						consuming: '', //耗时
						holdDay: '', //维持时间
						time: 0,
						/*计算时段*/
						productImg1: '', //项目图片
						productImg2: '',
						productImg3: '',
						produtDetail: '', //项目详情
						//						produtExplain: '' //项目说明
					},
					created: function() {

					},
					mounted: function() {
						var _this = this
						app.initHeader();
						var self = plus.webview.currentWebview()
						//						alert(self.product)
						if(self.product) {
							this.dstProduct = self.product
							this.title = "编辑项目"
							this.btn = "提交修改"
							this._initMsg()
						}
						mui.later(() => {
							plus.nativeUI.closeWaiting()
							mui.currentWebview.show('pop-in', 300, function() {}, {});
						}, 1500)
						/*初始化项目类别*/
						app.ajax(app.baseUrl + '/api/ProjectType/GetListPorjectType', {
							// dataType:'json',//服务器返回json格式数据
							type: 'get', //HTTP请求类型
							timeout: 10000, //超时时间设置为10秒；
							headers: {
								'Content-Type': 'application/x-www-form-urlencoded',
							},
							success: function(result) {
								/*赋值*/
								_this.productTypeList = result;
							},
							error: function(xhr, type, errorThrown) {
								//异常处理；
								console.log(type);
							}
						});
					},
					methods: {
						/*修改信息测初始化赋值*/
						_initMsg() {
							/*赋值信息*/
							this.productName = this.dstProduct.PROJECT_NAME; //项目名字
							this.productType = this.dstProduct.PROJECT_TYPE; //类型
							this.productClass = this.dstProduct.PROJECT_CLASS; //项目分类
							this.productLabel = this.dstProduct.PROJECT_LABLE; //项目标签
							this.originalPrice = this.dstProduct.PROJECT_PRICE; //原价
							this.currentPrice = this.dstProduct.PROJECT_DISCOUNT; //现价

							this.usePlatform = this.dstProduct.IS_DISCOUNT == 1 ? true : false; //是否使用平台活动
							//							this.joinPlatform=this.dstProduct.IS_ACTIVITY==1?true:false; //是否参加平台活动

							this.consuming = this.dstProduct.LIFETIME_COUNT; //耗时
							this.holdDay = this.dstProduct.KEEP_COUNT; //维持时间
							this.time = this.dstProduct.BOOKING_COUNT;
							/*计算时段*/
							if(this.dstProduct.PROJECT_IMG1) this.productImg1 = this.dstProduct.PROJECT_IMG1; //项目图片
							if(this.dstProduct.PROJECT_IMG2) this.productImg2 = this.dstProduct.PROJECT_IMG2;
							if(this.dstProduct.PROJECT_IMG3) this.productImg3 = this.dstProduct.PROJECT_IMG3;

							this.produtDetail = this.dstProduct.PROJECT_DETAILS; //项目详情
							//							this.produtExplain=this.dstProduct.PROJECT_STATE //项目说明

						},
						/*更新信息*/
						_updatedMsg(key) {
							var _this = this;
							switch(key) {
								case 1:
									app.ajax(app.baseUrl + '/api/ProjectType/GetListProjectClass', {
										// dataType:'json',//服务器返回json格式数据
										data: {
											porjectType: _this.productType
										},
										type: 'get', //HTTP请求类型
										timeout: 10000, //超时时间设置为10秒；
										headers: {
											'Content-Type': 'application/x-www-form-urlencoded',
										},
										success: function(result) {
											/*赋值*/
											_this.productClassList = result;
										},
										error: function(xhr, type, errorThrown) {
											//异常处理；
											console.log(type);
										}
									});
									break;
								case 2:
									//								alert(_this.productClass)
									app.ajax(app.baseUrl + '/api/ProjectType/GetListProjectLable', {
										// dataType:'json',//服务器返回json格式数据
										data: {
											projectClass: _this.productClass
										},
										type: 'get', //HTTP请求类型
										timeout: 10000, //超时时间设置为10秒；
										headers: {
											'Content-Type': 'application/x-www-form-urlencoded',
										},
										success: function(result) {
											/*赋值*/
											_this.productLabelList = result;
											//											console.log(JSON.stringify(_this.productLabelList))
										},
										error: function(xhr, type, errorThrown) {
											//异常处理；
											console.log(type);
										}
									});
									break;
								case 3:
									_this.usePlatform = !_this.usePlatform;
									break;
								case 4:
									//									_this.joinPlatform = !_this.joinPlatform;
									break;
								case 5:
									/*计算时段*/
									_this.time = Math.ceil(_this.consuming / 15)
									break;
								case 6:
									/*添加时段*/
									if(!_this.consuming) {
										plus.nativeUI.alert("请先填写耗时时间", function() {}, "马嘿嘿提醒您", "ok");
										return
									}
									_this.time += 1
									break;
									/*图片上传*/
								case 7:
									//									app.getIMG('上传项目图片', (src) => {
									//										this.productImg1 = src
									////										console.log(src)
									//									})
									Clip.getIMG('选择头像', (src) => {
										mui.openWindow({
											url: '../imgClick.html',
											id: 'imgClick',
											styles: {
												top: '0px', //新页面顶部位置
												bottom: '0px', //新页面底部位置
												scrollIndicator: "none",
												plusrequire: 'ahead'
											},
											createNew: false, //是否重复创建同样id的webview，默认为false:不重复创建，直接显示
											show: {
												autoShow: false, //页面loaded事件发生后自动显示，默认为true
												duration: 300 //页面动画持续时间，Android平台默认100毫秒，iOS平台默认200毫秒；
											},
											extras: {
												img: src,
												pid: 'product_edit',
												size: 1,
												mark: 1
											},
											waiting: {
												autoShow: true, //自动显示等待框，默认为true
												title: '正在加载...', //等待对话框上显示的提示内容
											}
										})
									})
									break;
								case 8:
									//									app.getIMG('上传项目图片', (src) => {
									//										this.productImg2 = src
									////										console.log(src)
									//									})
									Clip.getIMG('选择头像', (src) => {
										mui.openWindow({
											url: '../imgClick.html',
											id: 'imgClick',
											styles: {
												top: '0px', //新页面顶部位置
												bottom: '0px', //新页面底部位置
												scrollIndicator: "none",
												plusrequire: 'ahead'
											},
											createNew: false, //是否重复创建同样id的webview，默认为false:不重复创建，直接显示
											show: {
												autoShow: false, //页面loaded事件发生后自动显示，默认为true
												duration: 300 //页面动画持续时间，Android平台默认100毫秒，iOS平台默认200毫秒；
											},
											extras: {
												img: src,
												pid: 'product_edit',
												size: 1,
												mark: 2
											},
											waiting: {
												autoShow: true, //自动显示等待框，默认为true
												title: '正在加载...', //等待对话框上显示的提示内容
											}
										})
									})
									break;
								case 9:
									//									app.getIMG('上传项目图片', (src) => {
									//										this.productImg3 = src
									////										console.log(src)
									//									})
									Clip.getIMG('选择头像', (src) => {
										mui.openWindow({
											url: '../imgClick.html',
											id: 'imgClick',
											styles: {
												top: '0px', //新页面顶部位置
												bottom: '0px', //新页面底部位置
												scrollIndicator: "none",
												plusrequire: 'ahead'
											},
											createNew: false, //是否重复创建同样id的webview，默认为false:不重复创建，直接显示
											show: {
												autoShow: false, //页面loaded事件发生后自动显示，默认为true
												duration: 300 //页面动画持续时间，Android平台默认100毫秒，iOS平台默认200毫秒；
											},
											extras: {
												img: src,
												pid: 'product_edit',
												size: 1,
												mark: 3
											},
											waiting: {
												autoShow: true, //自动显示等待框，默认为true
												title: '正在加载...', //等待对话框上显示的提示内容
											}
										})
									})
									break;
								default:
									break;
							}
						},
						/*提交发布*/
						_submit() {

							var _this = this
							if(!this.productName || !this.productType || !this.productClass || !this.productLabel || !this.originalPrice || !this.currentPrice || !this.consuming || !this.holdDay || !this.produtDetail) {
								plus.nativeUI.alert("请完善当项目资料信息", function() {}, "马嘿嘿提醒您", "ok");
								return
							}
							if(!this.productImg1) {
								plus.nativeUI.alert("请完善上传项目图片", function() {}, "马嘿嘿提醒您", "ok");
								return
							}

							var PROJECT_STATUS;

							var self = plus.webview.currentWebview()
							/*若是编辑*/
							if(self.product) {

								_this._addProduction()
								return;
							}

							/*若是新添加*/
							if(mui.os.plus) {
								var a = [{
									title: '直接提交审核'
								}, {
									title: '保存到未提交项目'
								}];
								plus.nativeUI.actionSheet({
									title: '发布项目',
									cancel: '取消',
									buttons: a
								}, function(b) {
									switch(b.index) {
										case 0:
											return;
											break;
										case 1:
											//直接提交审核 
											_this._addProduction(2)
											break;
										case 2:
											//保存到未提交项目 
											_this._addProduction(0)
											break;
										default:
											break;
									}
								}, false);
							}

						},
						/*提交接口*/
						_addProduction(t) {

							var _this = this;
							plus.nativeUI.showWaiting();
							var data = {
								PROJECT_NAME: _this.productName,
								PROJECT_TYPE: _this.productType,
								PROJECT_CLASS: _this.productClass,
								PROJECT_LABLE: _this.productLabel,
								//								PROJECT_STATE: _this.produtExplain,
								PROJECT_DETAILS: _this.produtDetail,
								PROJECT_PRICE: _this.originalPrice,
								PROJECT_DISCOUNT: _this.currentPrice,
								IS_DISCOUNT: _this.usePlatform ? 1 : 0,
								//								IS_ACTIVITY: _this.joinPlatform ? 1 : 0,
								LIFETIME_COUNT: _this.consuming,
								BOOKING_COUNT: _this.time,
								KEEP_COUNT: _this.holdDay,
								PROJECT_IMG1: _this.productImg1,
								PROJECT_IMG2: _this.productImg2,
								PROJECT_IMG3: _this.productImg3
							}
							var url = '/api/BusiProject/UpdateProject'

							if(t == 0 || t == 2) {
								data.PROJECT_STATUS = t
								url = '/api/BusiProject/CreateProject'
							} else {
								data.PROJECT_CODE = this.dstProduct.PROJECT_CODE;
								data.PROJECT_STATUS = 2
							}

							app.ajax(app.baseUrl + url, {
								// dataType:'json',//服务器返回json格式数据
								data: data,
								type: 'post', //HTTP请求类型
								success: function(result) {

									plus.nativeUI.closeWaiting()
									if(result.Success) {
										var msg = "修改成功";
										if(t == 0 || t == 2) {
											msg = '发布成功'
										}
										plus.webview.getWebviewById('production').evalJS('refresh()')
										plus.nativeUI.alert(msg, function() {
											mui.back()
										}, "马嘿嘿提醒您", "ok");
										/*还原数据*/
									} else {
										plus.nativeUI.toast(result.Msg)
										console.log(result.Msg)

									}

								}
							});
						},
						_chooseAvatar(res){
							var key = res.mark;
//							alert(key)
							switch (key){
								case 1:
								this.productImg1 = res.src
									break;
								case 2:
								this.productImg2 = res.src
									break;
								case 3:
								this.productImg3 = res.src
									break;
								default:
									break;
							}
						}
					}

				})
			})
			function choosePic(res) {
				plus.nativeUI.closeWaiting()
				res = JSON.parse(res)
				APP._chooseAvatar(res)
			}
		</script>
	</body>

	</html